name: "CodeQL Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  # schedule:
  #   - cron: '0 3 * * 1'  # Lunes 3AM UTC

jobs:
  codeql_analysis:
    name: Analyze Code with CodeQL
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: "python"

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: codeql-results.sarif

      - name: Upload CodeQL results as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results
          path: codeql-results.sarif

  codeql_create_engagement:
    name: Create engagement in DefectDojo - CodeQL
    needs: codeql_analysis
    runs-on: ubuntu-latest

    env:
      # Respeto tus valores:
      DEFECTDOJO_URL: "http://107.21.152.191:8080"
      DEFECTDOJO_TOKEN: "2ff51b58d24988ccb47580fd79dab1a95d193ff7"

      # Config engagement
      DEFECTDOJO_ENGAGEMENT_PERIOD: "28"
      DEFECTDOJO_ENGAGEMENT_STATUS: "In Progress"

      # Producto: podés setear ID o Nombre (si no existe, se crea)
      DEFECTDOJO_PRODUCTID: ""                 # si sabés el ID, ponelo acá
      DEFECTDOJO_PRODUCT_NAME: "devsecops_v1_BIT"

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq coreutils

      - name: Set engagement dates (UTC)
        run: |
          echo "TODAY=$(date -u +%Y-%m-%d)" >> $GITHUB_ENV
          echo "ENDDAY=$(date -u -d \"+${DEFECTDOJO_ENGAGEMENT_PERIOD:-28} days\" +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Sanity check DefectDojo connectivity
        run: |
          set -e
          BASE="${DEFECTDOJO_URL%/}/api/v2"
          curl -fsS "$BASE/engagements/?limit=1" \
            -H "Authorization: Token ${DEFECTDOJO_TOKEN}" \
            -H "Accept: application/json" -o /dev/null
          echo "✅ Conexión con Dojo OK"

      - name: Resolve/ensure DefectDojo Product
        run: |
          set -euo pipefail
          BASE="${DEFECTDOJO_URL%/}/api/v2"
          AUTH="Authorization: Token ${DEFECTDOJO_TOKEN}"

          # 1) Si me diste un ID explícito, lo valido
          if [ -n "${DEFECTDOJO_PRODUCTID:-}" ]; then
            code=$(curl -s -o /dev/null -w "%{http_code}" -H "$AUTH" "$BASE/products/${DEFECTDOJO_PRODUCTID}/")
            if [ "$code" -ge 200 ] && [ "$code" -lt 300 ]; then
              echo "PRODUCT_ID=${DEFECTDOJO_PRODUCTID}" >> $GITHUB_ENV
            fi
          fi

          # 2) Si no hay PRODUCT_ID válido, busco por nombre (case-insensitive)
          if [ -z "${PRODUCT_ID:-}" ]; then
            NAME="${DEFECTDOJO_PRODUCT_NAME:-devsecops_v1_BIT}"
            id=$(curl -s -H "$AUTH" "$BASE/products/?name__iexact=${NAME}" | jq -r '.results[0].id // empty')
            if [ -n "$id" ]; then
              echo "PRODUCT_ID=$id" >> $GITHUB_ENV
            else
              # 3) Si no existe, creo ProductType (si hace falta) y Product
              pt=$(curl -s -H "$AUTH" "$BASE/product_types/?limit=1" | jq -r '.results[0].id // empty')
              if [ -z "$pt" ]; then
                pt=$(curl -s -X POST -H "$AUTH" -H "Content-Type: application/json" \
                      "$BASE/product_types/" --data '{"name":"Default"}' | jq -r '.id')
              fi
              new=$(jq -n --arg name "$NAME" --argjson pt "$pt" '{name:$name, prod_type:$pt}')
              id=$(curl -s -X POST -H "$AUTH" -H "Content-Type: application/json" \
                    "$BASE/products/" --data "$new" | jq -r '.id')
              if [ -z "$id" ] || [ "$id" = "null" ]; then
                echo "❌ No pude crear el Product en DefectDojo"; exit 1
              fi
              echo "PRODUCT_ID=$id" >> $GITHUB_ENV
              echo "✅ Product creado: $NAME (ID=$id)"
            fi
          fi

      - name: Create engagement in DefectDojo (minimal payload)
        id: create_engagement
        shell: bash
        run: |
          set -euo pipefail

          DESC="${{ github.event.head_commit.message }}"
          if [ -z "$DESC" ]; then DESC="${{ github.event.pull_request.title }}"; fi
          if [ -z "$DESC" ]; then DESC="CodeQL run"; fi

          payload=$(jq -n \
            --arg name "CodeQL_#${{ github.run_id }}" \
            --arg description "$DESC" \
            --arg status "${DEFECTDOJO_ENGAGEMENT_STATUS}" \
            --arg start "${TODAY}" \
            --arg end   "${ENDDAY}" \
            --arg type  "CI/CD" \
            --argjson product ${PRODUCT_ID} \
            '{ name: $name, description: $description, status: $status,
               engagement_type: $type, target_start: $start, target_end: $end,
               product: $product }')

          echo "$payload" > payload.json

          http_code=$(curl -sS -o id.json -w "%{http_code}" -X POST \
            "${DEFECTDOJO_URL%/}/api/v2/engagements/" \
            -H "Authorization: Token ${DEFECTDOJO_TOKEN}" \
            -H "Content-Type: application/json" \
            --data @payload.json)

          echo "HTTP ${http_code}"
          cat id.json || true

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "❌ Falló la creación del engagement (HTTP ${http_code})"
            exit 1
          fi

          ENGAGEMENT_ID=$(jq -r '.id' id.json)
          echo "DEFECTDOJO_ENGAGEMENTID=${ENGAGEMENT_ID}" | tee -a defectdojo1.env
          echo "engagement_id=${ENGAGEMENT_ID}" >> "$GITHUB_OUTPUT"
          echo "✅ Engagement creado: ID=${ENGAGEMENT_ID}"

      - name: Upload debug artifacts (payload & id)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: defectdojo-debug
          path: |
            payload.json
            id.json

      - name: Upload defectdojo1.env
        uses: actions/upload-artifact@v4
        with:
          name: defectdojo1-env
          path: defectdojo1.env
